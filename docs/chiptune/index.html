<!DOCTYPE html>
<html lang="en">

<head>
    <title>A Chiptune Music System with OPL2 and Reality Adlib Tracker | liu&#x27;s website</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://liu2g.github.io/style.css">
    <link rel="stylesheet" href="https://liu2g.github.io/color/green-auto.css">

        <link rel="stylesheet" href="https://liu2g.github.io/color/background_blue.css">
    
    <link rel="stylesheet" href="https://liu2g.github.io/font-hack-subset.css">

        <link rel="shortcut icon" type="image/png" href="/favicon.png">
    

<link rel="stylesheet" href="https://liu2g.github.io/katex.css">
<script defer src="https://liu2g.github.io/katex.js"></script>
<script defer src="https://liu2g.github.io/auto-render.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "$", right: "$", display: false},
            ]
        });
    });
</script>


<script async defer src="https://nullitics.com/script.js"></script>

</head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://liu2g.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            liu
                        
                    </div>
                </a>
            </div>
        </div>

        
        <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://liu2g.github.io/about">about me</a></li>
            
                <li><a href="https://github.com/liu2g/resume/releases/latest" target="_blank" rel="noopener noreferrer">resume</a></li>
            
                <li><a href="https://liu2g.github.io/projects">projects</a></li>
            
                <li><a href="https://liu2g.github.io/tags">tags</a></li>
            
                <li><a href="https://github.com/liu2g" target="_blank" rel="noopener noreferrer">    <svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em"
        viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M10.9,2.1c-4.6,0.5-8.3,4.2-8.8,8.7c-0.5,4.7,2.2,8.9,6.3,10.5C8.7,21.4,9,21.2,9,20.8v-1.6c0,0-0.4,0.1-0.9,0.1 c-1.4,0-2-1.2-2.1-1.9c-0.1-0.4-0.3-0.7-0.6-1C5.1,16.3,5,16.3,5,16.2C5,16,5.3,16,5.4,16c0.6,0,1.1,0.7,1.3,1c0.5,0.8,1.1,1,1.4,1 c0.4,0,0.7-0.1,0.9-0.2c0.1-0.7,0.4-1.4,1-1.8c-2.3-0.5-4-1.8-4-4c0-1.1,0.5-2.2,1.2-3C7.1,8.8,7,8.3,7,7.6c0-0.4,0-0.9,0.2-1.3 C7.2,6.1,7.4,6,7.5,6c0,0,0.1,0,0.1,0C8.1,6.1,9.1,6.4,10,7.3C10.6,7.1,11.3,7,12,7s1.4,0.1,2,0.3c0.9-0.9,2-1.2,2.5-1.3 c0,0,0.1,0,0.1,0c0.2,0,0.3,0.1,0.4,0.3C17,6.7,17,7.2,17,7.6c0,0.8-0.1,1.2-0.2,1.4c0.7,0.8,1.2,1.8,1.2,3c0,2.2-1.7,3.5-4,4 c0.6,0.5,1,1.4,1,2.3v2.6c0,0.3,0.3,0.6,0.7,0.5c3.7-1.5,6.3-5.1,6.3-9.3C22,6.1,16.9,1.4,10.9,2.1z" ></path>
    </svg>
    </a></li>
            
                <li><a href="https://gitlab.com/liu2g" target="_blank" rel="noopener noreferrer">    <svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em"
        viewBox="0 0 50 50" fill="none" stroke="currentColor">
            <path d="M 38.011719 4 C 37.574219 3.996094 37.183594 4.273438 37.046875 4.691406 L 32.074219 20 L 17.925781 20 L 12.953125 4.691406 C 12.820313 4.289063 12.449219 4.011719 12.023438 4 C 11.597656 3.992188 11.214844 4.25 11.0625 4.648438 L 5.070313 20.640625 C 5.066406 20.640625 5.066406 20.644531 5.0625 20.648438 L 2.0625 28.648438 C 1.90625 29.070313 2.046875 29.542969 2.414063 29.808594 L 24.40625 45.800781 L 24.410156 45.808594 C 24.414063 45.808594 24.414063 45.808594 24.414063 45.8125 C 24.425781 45.820313 24.441406 45.828125 24.453125 45.835938 C 24.46875 45.84375 24.480469 45.855469 24.496094 45.863281 C 24.5 45.863281 24.5 45.867188 24.503906 45.867188 C 24.503906 45.867188 24.507813 45.871094 24.511719 45.871094 C 24.515625 45.875 24.519531 45.878906 24.527344 45.878906 C 24.53125 45.882813 24.539063 45.886719 24.542969 45.890625 C 24.5625 45.898438 24.585938 45.910156 24.609375 45.917969 C 24.609375 45.917969 24.609375 45.917969 24.609375 45.921875 C 24.632813 45.929688 24.65625 45.9375 24.675781 45.945313 C 24.679688 45.945313 24.679688 45.945313 24.683594 45.949219 C 24.699219 45.953125 24.714844 45.957031 24.734375 45.964844 C 24.742188 45.964844 24.75 45.96875 24.761719 45.96875 C 24.761719 45.972656 24.761719 45.972656 24.761719 45.96875 C 24.78125 45.976563 24.800781 45.980469 24.820313 45.984375 C 24.847656 45.988281 24.871094 45.992188 24.898438 45.996094 C 24.9375 45.996094 24.980469 46 25.019531 46 C 25.058594 45.996094 25.09375 45.996094 25.128906 45.988281 C 25.144531 45.988281 25.15625 45.988281 25.171875 45.984375 C 25.171875 45.984375 25.175781 45.984375 25.179688 45.984375 C 25.1875 45.980469 25.191406 45.980469 25.199219 45.980469 C 25.203125 45.980469 25.207031 45.976563 25.214844 45.976563 C 25.222656 45.972656 25.234375 45.972656 25.242188 45.96875 C 25.257813 45.964844 25.269531 45.960938 25.28125 45.957031 C 25.289063 45.957031 25.292969 45.957031 25.296875 45.953125 C 25.300781 45.953125 25.304688 45.953125 25.308594 45.953125 C 25.324219 45.945313 25.34375 45.9375 25.359375 45.933594 C 25.378906 45.925781 25.394531 45.917969 25.410156 45.910156 C 25.414063 45.910156 25.414063 45.910156 25.417969 45.90625 C 25.421875 45.90625 25.425781 45.90625 25.429688 45.902344 C 25.4375 45.898438 25.445313 45.894531 25.453125 45.890625 C 25.476563 45.878906 25.496094 45.867188 25.515625 45.855469 C 25.523438 45.851563 25.527344 45.847656 25.53125 45.84375 C 25.535156 45.84375 25.539063 45.839844 25.542969 45.839844 C 25.558594 45.828125 25.574219 45.820313 25.589844 45.808594 L 25.597656 45.796875 L 47.589844 29.808594 C 47.953125 29.542969 48.09375 29.070313 47.9375 28.648438 L 44.945313 20.675781 C 44.941406 20.667969 44.9375 20.65625 44.9375 20.648438 L 38.9375 4.648438 C 38.789063 4.261719 38.425781 4.003906 38.011719 4 Z M 11.933594 8.027344 L 15.824219 20 L 7.445313 20 Z M 38.066406 8.027344 L 42.558594 20 L 34.175781 20 Z M 8.066406 22 L 16.472656 22 L 22.328125 40.015625 Z M 18.578125 22 L 31.421875 22 L 25 41.765625 Z M 33.527344 22 L 41.933594 22 L 27.671875 40.015625 Z M 6.3125 23.007813 L 19.6875 39.902344 L 4.203125 28.640625 Z M 43.6875 23.007813 L 45.796875 28.640625 L 30.3125 39.902344 Z"></path>
    </svg>
    </a></li>
            
                <li><a href="https://www.linkedin.com/in/liu2g" target="_blank" rel="noopener noreferrer">    <svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em"
        viewBox="0 0 30 30" fill="none" stroke="currentColor">
            <path d="M24,4H6C4.895,4,4,4.895,4,6v18c0,1.105,0.895,2,2,2h18c1.105,0,2-0.895,2-2V6C26,4.895,25.105,4,24,4z M10.954,22h-2.95 v-9.492h2.95V22z M9.449,11.151c-0.951,0-1.72-0.771-1.72-1.72c0-0.949,0.77-1.719,1.72-1.719c0.948,0,1.719,0.771,1.719,1.719 C11.168,10.38,10.397,11.151,9.449,11.151z M22.004,22h-2.948v-4.616c0-1.101-0.02-2.517-1.533-2.517 c-1.535,0-1.771,1.199-1.771,2.437V22h-2.948v-9.492h2.83v1.297h0.04c0.394-0.746,1.356-1.533,2.791-1.533 c2.987,0,3.539,1.966,3.539,4.522V22z"></path>
    </svg>
    </a></li>
            
                <li><a href="mailto:leo85811nardo@protonmail.com" target="_blank" rel="noopener noreferrer">    <svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em"
        viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
    </svg>
    </a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://liu2g.github.io/chiptune/">A Chiptune Music System with OPL2 and Reality Adlib Tracker</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2019-12-02
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://liu2g.github.io/tags/c-c/">#C&#x2F;C++</a>&nbsp;
                <a class="post-tag" href="https://liu2g.github.io/tags/class-project/">#class-project</a>&nbsp;
                <a class="post-tag" href="https://liu2g.github.io/tags/electronics/">#electronics</a>&nbsp;
                <a class="post-tag" href="https://liu2g.github.io/tags/embedded/">#embedded</a></span>
    

        
        <div class="post-content">
            <p>he source of the project can be found at my GitHub
<a href="https://github.com/liu2g/opl2-chiptune">repo</a>.</p>
<p>The objective of the project is to build a system with the old-school electronic
components that plays Chiptune music, as well as composing the music with
compatible software. This is a project for the class Japanese Music Online
during Fall 2019 semester. Dr. Kazuaki Shiota was really nice to let me do this
for the final project of the class. The project helped me understand the theory
behind Chiptune Music from a musical and engineering standpoint.</p>
<h3 id="how-chiptune-music-works">How Chiptune Music Works</h3>
<h4 id="beeper-speakers">Beeper Speakers</h4>
<p>In embedded systems, I have experimented generating music made by square-waves
with a piezoelectric speaker. The tone of the music is adjusted by the frequency
of the square waves, as a method called &quot;Frequency Modulation (FM)&quot;. Such
&quot;beeper speaker&quot; system is how early home computers generate sounds, except the
CPU also handles other processes as a normal PC does (Figure 1). Different tones
can be played by varying the frequency of the square waves, however, it requires
all of the CPU's run-time to implement advanced sound of music.</p>
<h4 id="fm-synthesizer">FM Synthesizer</h4>
<p>To solve this issue, computers in the early 1980's use dedicated sound chip
(Figure 2), which is the early form of the sound cards in today's computers.
Except for taking the processing load away from the CPU, this method also
creates possibility to develop more advanced sound generation and even
synthesis. Three examples can be examined as examples.</p>
<figure>
  <img src="fm-synth.png"/>
  <figcaption> <small> Figure 1 (Left) - Non-Dedicated Sound Chip; Figure 2 (Right) - Dedicated Sound Chip </small> </figcaption>
</figure>
<h4 id="nintendo-entertainment-system-nes">Nintendo Entertainment System (NES)</h4>
<p>The sound chip in NES is able to generate five channels, each of which features
different types of waveforms (Figure 3). Channel #1 and #2 gives square waves,
Channel #3 gives triangle waves, Channel #4 gives noise and Channel #5 is PCM
sample, which modulate pre-recorded sound waves. Though the tone can be
different, this method makes the music sounds like being played by the same set
of instruments.</p>
<figure>
  <img src="NES.png"/>
  <figcaption> <small> Figure 3 - NES Sound Chip </small> </figcaption>
</figure>
<h4 id="commodore-64">Commodore 64</h4>
<p>Commodore uses a different approach to synthesize music. The chip has 3
channels, each of which can produce waveforms among square, triangle and
sawtooth wave (Figure 4) . Initially, engineers assign used to assign one
waveform to a channel and write the tone associated with the wave. This seems
inferior to the NES system as it only has 3 channels, despite that the
combination of the waveforms can be variable. However, later engineers realized
that waveform can be reassigned to channels on the fly, which has opened a great
amount of variability to the music. This methods have been proved successful and
extended to the next generation of sound card in PC.</p>
<figure>
  <img src="C64.png"/>
  <figcaption> <small> Figure 4 - Commodore 64 Sound Chip </small> </figcaption>
</figure>
<h4 id="adlib-sound-blaster-card">Adlib/Sound-Blaster Card</h4>
<p>As an improved version of the Commodor 64 sound chip, the Adlib Sound Card is
used in the later IBM PC. The Card is replaced with Sound Blaster later due to
the market loss,  but the key component - YM3812 FM Operator chip is used in
both boards. This chip is considered the foundation of computer music on IBM PC
for a decade, and can even found in some Yamaha electronic piano keyboards.</p>
<p><strong>YM3812</strong> is an Frequency Modulation Operator Type-L2 (OPL2) integrated chip
that can simultaneously generate 9 channels of different types of waveforms.
Since this chip was widely used in early computer systems, there are still
supporting documents, software, and projects related to it, so it has been
determined as the core of this project as well.</p>
<h3 id="hardware-setup">Hardware Setup</h3>
<p>Figure 5 is the hardware setup of the system in block diagram. The music file
stored in the SD card is read by the microcontroller (μC). The OPL2 chip uses
4-line bus for control signal and 8-line bus for data transfer. To reduce the
load on the microcontroller, the data is sent in serial first to a shift
register, and then transmitted to the OPL2 chip after the conversion. The
digital output of the FM operation is thereafter transferred to a DAC, whose
analog output is amplified to become the eventual sound that can be played by a
speaker.</p>
<figure>
  <img src="block.png"/>
  <figcaption> <small> Figure 5 - Block Diagram </small> </figcaption>
</figure>
<p>The detailed schematic of the system is in Figure 9. It is made in KiCAD, a free
CAD software for PCB design. In order to reduce the cross-talk and noise of the
system, it was decided to make the system into a PCB. After a few hours' layout
design, the final version of the board (Figure 10) is submitted to OSH Park
Proto-PCB Service.</p>
<p>The KiCAD files are available in the GitHub repository attached at the begining
of the post.</p>
<figure>
  <img src="schematic.png"/>
  <figcaption> <small> Figure 6 - Circuit Schematic </small> </figcaption>
</figure>
<figure>
  <img src="pcb.png"/>
  <figcaption> <small> Figure 7 - PCB Demo </small> </figcaption>
</figure>
<h3 id="software">Software</h3>
<p>The software portion of the project consists of the controlling program on the
microcontroller and the music composing software.</p>
<p>Since the microcontroller is determined to be Arduino Uno as it's the most
available option, the controlling program is written in C++ in Arduino IDE. In
addition to an external OPL2 library that handles the communication protocol,
libraries such as SD and SPI are included too for the SD module board. The
Arduino code is available in the GitHub repository attached at the end of the
post.</p>
<p>Reality Adlib Tacker II (Figure 11) is the software for me to compose the music.
It is a music tracker with an old-school GUI but an extensive documentation.</p>
<figure>
  <img src="reality.png"/>
  <figcaption> <small> Figure 8 - Reality Adlib Tracker </small> </figcaption>
</figure>
<h3 id="result-demonstration">Result Demonstration</h3>
<p>Before the PCB design is manufactured, an alpha prototype is made on a
breadboard, in order to test the functionality of the design. The video below
demonstrates the alpha system playing a sample test music.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/rFG_2tbkUiI" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>Knowing that the design is functional, the next phase was a hardware and
software upgrade. Hardware-wise, the PCB was sent to the manufacturer and
assembled later. Software-wise, a specific piece of music was chosen to be
recreated with the Tracker by myself. The video below is the final version of
the system, playing Megalovania from the game Undertale.</p>
<h3 id="summary-and-recommendation">Summary and Recommendation</h3>
<p>To me, this multi-disciplinary project was not only successful but also
meaningful.</p>
<p>In a music standpoint, I learned how early electronic/computer music works and
experienced the same method of composing it as the early 1900s game designed
did. I am amazed too by the ingenuity of them making a variety of music with
such limited system. Luckily, chiptune (or 8-bit) music remains as a featured
style of music nowadays, which, to some extent, pays a tribute to those who used
to work on electronic music composition.</p>
<p>In an electrical engineering standpoint, this is a thorough embedded system
engineering project starting from an idea, to research, design, assembly,
testing and eventually realization. A lot of effort was used in designing the
circuit, which is one of reasons of deciding to make a PCB. I also gained
experience in audio engineering, such as signal amplification and reducing
noise.</p>
<p>Finally, some recommendations are listed for future improvement.</p>
<ol>
<li>Instead of using Arduino Uno board, the system can be simpler by integrating
Teensy board into the PCB. Thus, the system will become an actual sound card.</li>
<li>The OPL2 library was used, but not fully understood yet. Reading through the
code may help understanding the theories of operation even more.</li>
<li>The process of loading the sound file in the SD card is time-consuming. It
can be improved by developing a direct interface with PC and the system.</li>
</ol>

        </div>

        
        <div class="pagination">
            <div class="pagination__title">
                <span class="pagination__title-h">See more projects</span>
                <hr />
            </div>
            <div class="pagination__buttons">
                    <span class="button previous">
                        <a href="https://liu2g.github.io/nullclineplot/">
                            <span class="button__icon">←</span>&nbsp;
                            <span class="button__text">Mathematical Steady State Analysis by Plotting in Python</span>
                        </a>
                    </span>
                
                
                    <span class="button next">
                        <a href="https://liu2g.github.io/gastrack/">
                            <span class="button__text">Developing a Gas Price Tracking and Prediction Application</span>&nbsp;
                            <span class="button__icon">→</span>
                        </a>
                    </span>
                </div>
        </div>
    
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright copyright--user">Licensed under&nbsp;<a rel="license nofollow noopener noreferrer"
    href="https://creativecommons.org/licenses/by/4.0/" target="_blank">
    CC-BY-4.0</a></div>
            </div>
    </footer>
    

</div>
</body>

</html>
